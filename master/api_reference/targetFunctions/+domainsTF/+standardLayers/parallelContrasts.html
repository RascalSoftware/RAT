<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of parallelContrasts</title>
  <meta name="keywords" content="parallelContrasts">
  <meta name="description" content="Single threaded version of the Standard Layers calculation">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003-2019 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../../menu.html targetFunctions -->
<!-- ../menu.html +domainsTF -->
<!-- menu.html +standardLayers -->

<h1>parallelContrasts
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>Single threaded version of the Standard Layers calculation</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,domainSldProfiles,allLayers,allRoughs] = parallelContrasts(problemDef,problemDefCells,controls) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Single threaded version of the Standard Layers calculation 
 This is the main reflectivity calculation of the standard layers
 calculation type. It extracts the required parameters for the contrasts
 from the input arrays, then passes the main calculation to
 'standardLayersCore', which carries out the calculation itself. 
 The core calculation is common for both standard and custom layers.
</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../targetFunctions/+domainsTF/+customLayers/parallelPoints.html" class="code" title="function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,domainSldProfiles,allLayers,allRoughs] = parallelPoints(problemDef,problemDefCells,controls)">parallelPoints</a>	Single threaded version of the custom layers, domainsTF reflectivity</li>
<li><a href="../../../targetFunctions/+domainsTF/+customXY/parallelPoints.html" class="code" title="function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,domainSldProfiles,allLayers,allRoughs] = parallelPoints(problemDef,problemDefCells,controls)">parallelPoints</a>	Extract individual cell arrays</li>
<li><a href="parallelPoints.html" class="code" title="function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,domainSldProfiles,allLayers,allRoughs] = parallelPoints(problemDef,problemDefCells,controls)">parallelPoints</a>	Single threaded version of the Standard Layers calculation</li>
<li><a href="../../../targetFunctions/+nonPolarisedTF/+customLayers/parallelPoints.html" class="code" title="function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,sldProfiles,allLayers,allRoughs] = parallelPoints(problemDef,problemDefCells,controls)">parallelPoints</a>	Multi threaded version of the custom layers over reflectivity poimnts</li>
<li><a href="../../../targetFunctions/+nonPolarisedTF/+customXY/parallelPoints.html" class="code" title="function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,sldProfiles,allLayers,allRoughs] = parallelPoints(problemDef,problemDefCells,controls)">parallelPoints</a>	Multi threaded version of the custom XY profile over reflectivity points</li>
<li><a href="../../../targetFunctions/+nonPolarisedTF/+standardLayers/parallelPoints.html" class="code" title="function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,sldProfiles,allLayers,allRoughs] = parallelPoints(problemDef,problemDefCells,controls)">parallelPoints</a>	Standard Layers calculation paralelised over the inner loop</li>
<li><a href="../../../targetFunctions/common/backSort.html" class="code" title="function [outBackground,outQzshift,outScalefactor,outBulkIn,outBulkOut,outResolution] = backSort(contrastBackgrounds,contrastQzshifts,contrastScalefactors,contrastBulkIns,contrastBulkOuts,contrastResolutions,backs,qzshifts,scalefactor,bulkIn,bulkOut,res)">backSort</a>	Distributes the background and shift values among the different contrasts</li>
<li><a href="../../../targetFunctions/common/costFunctions/chiSquared.html" class="code" title="function chi2 = chiSquared(thisData,thisFit,P)">chiSquared</a>	Chi-squared function is used to evaluate the goodness of fit.</li>
<li><a href="../../../targetFunctions/common/extractProblemParams.html" class="code" title="function [numberOfContrasts, geometry, contrastBackgrounds, contrastQzshifts, contrastScalefactors, contrastBulkIns, contrastBulkOuts,contrastResolutions, backs, shifts, scalefactor, bulkIn, bulkOut, res, dataPresent, nParams, params,numberOfLayers, resample, backsType, contrastCustomFiles] =  extractProblemParams(problemDef)">extractProblemParams</a>	Extract individual parameters from problemDef</li>
<li><a href="../../../targetFunctions/common/groupLayers/allocateLayersForContrast.html" class="code" title="function     thisContrastLayers = allocateLayersForContrast(contrastLayers,outParameterisedLayers,useImaginary)">allocateLayersForContrast</a>	Decide which layers are needed for a particular contrast.</li>
<li><a href="../../../targetFunctions/common/groupLayers/allocateParamsToLayers.html" class="code" title="function outLayers = allocateParamsToLayers(params, layersDetails)">allocateParamsToLayers</a>	Allocates parameters from the parameter array to the correct layers</li>
<li><a href="../../../targetFunctions/common/parseCells.html" class="code" title="function [repeatLayers,allData,dataLimits,simLimits,contrastLayers,layersDetails,customFiles] = parseCells(problemDefCells)">parseCells</a>	Splits up the master input list of all arrays into separate arrays</li>
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,</a><span class="keyword">...</span>
0002     Simulation,shifted_data,layerSlds,domainSldProfiles,allLayers,<span class="keyword">...</span>
0003     allRoughs] = parallelContrasts(problemDef,problemDefCells,controls)
0004 <span class="comment">% Single threaded version of the Standard Layers calculation</span>
0005 <span class="comment">% This is the main reflectivity calculation of the standard layers</span>
0006 <span class="comment">% calculation type. It extracts the required parameters for the contrasts</span>
0007 <span class="comment">% from the input arrays, then passes the main calculation to</span>
0008 <span class="comment">% 'standardLayersCore', which carries out the calculation itself.</span>
0009 <span class="comment">% The core calculation is common for both standard and custom layers.</span>
0010 
0011 
0012 <span class="comment">% Extract individual cell arrays</span>
0013 [repeatLayers,<span class="keyword">...</span>
0014  allData,<span class="keyword">...</span>
0015  dataLimits,<span class="keyword">...</span>
0016  simLimits,~,<span class="keyword">...</span>
0017  layersDetails,~] = <a href="../../../targetFunctions/common/parseCells.html" class="code" title="function [repeatLayers,allData,dataLimits,simLimits,contrastLayers,layersDetails,customFiles] = parseCells(problemDefCells)">parseCells</a>(problemDefCells);
0018 
0019 <span class="comment">% Additionally extract the additional domain layers details</span>
0020 domainContrastLayers = problemDefCells{19};
0021 
0022 <span class="comment">% Extract individual parameters from problemDef struct</span>
0023 [numberOfContrasts, geometry, contrastBackgrounds, contrastQzshifts, contrastScalefactors, contrastBulkIns, contrastBulkOuts,<span class="keyword">...</span>
0024 contrastResolutions, backs, shifts, scalefactor, bulkIn, bulkOut, res, dataPresent, nParams, params,<span class="keyword">...</span>
0025 ~, resample, backsType, ~] =  <a href="../../../targetFunctions/common/extractProblemParams.html" class="code" title="function [numberOfContrasts, geometry, contrastBackgrounds, contrastQzshifts, contrastScalefactors, contrastBulkIns, contrastBulkOuts,contrastResolutions, backs, shifts, scalefactor, bulkIn, bulkOut, res, dataPresent, nParams, params,numberOfLayers, resample, backsType, contrastCustomFiles] =  extractProblemParams(problemDef)">extractProblemParams</a>(problemDef);
0026 
0027 calcSld = controls.calcSldDuringFit;   
0028 useImaginary = problemDef.useImaginary;
0029 allDomainRatios = problemDef.domainRatio;
0030 contrastDomainRatios = problemDef.contrastDomainRatios;
0031 
0032 domainRatio = 1;    <span class="comment">% Default for compile.</span>
0033 
0034 <span class="comment">% Allocate the memory for the output arrays before the main loop</span>
0035 backgs = zeros(numberOfContrasts,1);
0036 qzshifts = zeros(numberOfContrasts,1);
0037 scalefactors = zeros(numberOfContrasts,1);
0038 bulkIns = zeros(numberOfContrasts,1);
0039 bulkOuts = zeros(numberOfContrasts,1);
0040 resols = zeros(numberOfContrasts,1);
0041 allRoughs = zeros(numberOfContrasts,1);
0042 outSsubs = zeros(numberOfContrasts,1);
0043 chis =  zeros(numberOfContrasts,1);
0044 layerSlds = cell(numberOfContrasts,2);
0045 domainSldProfiles = cell(numberOfContrasts,2);
0046 shifted_data = cell(numberOfContrasts,1);
0047 
0048 reflectivity = cell(numberOfContrasts,1);
0049 <span class="keyword">for</span> i = 1:numberOfContrasts
0050     reflectivity{i} = [1 1 ; 1 1];
0051 <span class="keyword">end</span>
0052 
0053 Simulation = cell(numberOfContrasts,1);
0054 <span class="keyword">for</span> i = 1:numberOfContrasts
0055     Simulation{i} = [1 1 ; 1 1];
0056 <span class="keyword">end</span>
0057 
0058 allLayers = cell(numberOfContrasts,2);
0059 <span class="keyword">for</span> i = 1:numberOfContrasts
0060     allLayers{i,1} = [1 1 1; 1 1 1];
0061     allLayers{i,2} = [1 1 1; 1 1 1];
0062 <span class="keyword">end</span>
0063 
0064 tempSldProfiles = cell(numberOfContrasts,1);
0065 <span class="keyword">for</span> i = 1:numberOfContrasts
0066     tempSldProfiles{i} = {[1 1 ; 1 1],[1 1 ; 1 1]};
0067 <span class="keyword">end</span>
0068 
0069 calcAllLayers = cell(numberOfContrasts,2);
0070 <span class="keyword">for</span> i = 1:numberOfContrasts
0071     calcAllLayers{i,1} = [1 ; 1];
0072     calcAllLayers{i,2} = [1 ; 1];
0073 <span class="keyword">end</span>
0074 
0075 tempAllLayers = cell(numberOfContrasts,1);
0076 <span class="keyword">for</span> i = 1:numberOfContrasts
0077     tempAllLayers{i} = {[1 1 1;1 1 1],[1 1 1;1 1 1]};
0078 <span class="keyword">end</span>
0079 
0080 tempLayerSlds = cell(numberOfContrasts,1);
0081 <span class="keyword">for</span> i = 1:numberOfContrasts
0082     tempLayerSlds{i} = {[1 1 1;1 1 1],[1 1 1;1 1 1]};
0083 <span class="keyword">end</span>
0084 <span class="comment">% end memory allocation.</span>
0085 
0086 <span class="comment">% First we need to allocate the absolute values of the input</span>
0087 <span class="comment">% parameters to all the layers in the layers list. This only needs</span>
0088 <span class="comment">% to be done once, and so is done outside the contrasts loop</span>
0089 outParameterisedLayers = <a href="../../../targetFunctions/common/groupLayers/allocateParamsToLayers.html" class="code" title="function outLayers = allocateParamsToLayers(params, layersDetails)">allocateParamsToLayers</a>(params, layersDetails);
0090 
0091 <span class="comment">% Resample params if requiired</span>
0092 resamPars = controls.resamPars;
0093 
0094 <span class="comment">% Loop over all the contrasts</span>
0095 parfor i = 1:numberOfContrasts
0096 
0097     <span class="comment">% Get the domain ratio for this contrast</span>
0098     thisContrastDR = contrastDomainRatios(i);
0099     <span class="keyword">if</span> isempty(thisContrastDR)
0100         thisContrastDR = 1;
0101     <span class="keyword">end</span>
0102     domainRatio = allDomainRatios(thisContrastDR);
0103 
0104     <span class="comment">% Extract the relevant parameter values for this contrast</span>
0105     <span class="comment">% from the input arrays.</span>
0106     <span class="comment">% First need to decide which values of the backgrounds, scalefactors</span>
0107     <span class="comment">% data shifts and bulk contrasts are associated with this contrast</span>
0108     [thisBackground,thisQzshift,thisScalefactor,thisBulkIn,thisBulkOut,thisResol] = <a href="../../../targetFunctions/common/backSort.html" class="code" title="function [outBackground,outQzshift,outScalefactor,outBulkIn,outBulkOut,outResolution] = backSort(contrastBackgrounds,contrastQzshifts,contrastScalefactors,contrastBulkIns,contrastBulkOuts,contrastResolutions,backs,qzshifts,scalefactor,bulkIn,bulkOut,res)">backSort</a>(contrastBackgrounds(i),contrastQzshifts(i),contrastScalefactors(i),contrastBulkIns(i),contrastBulkOuts(i),contrastResolutions(i),backs,shifts,scalefactor,bulkIn,bulkOut,res);
0109     
0110     <span class="comment">% Also need to determine which layers from the overall layers list</span>
0111     <span class="comment">% are required for this contrast, and put them in the correct order</span>
0112     <span class="comment">% according to geometry. We run it twice, once for each domain...</span>
0113     thisContrastLayers1 = <a href="../../../targetFunctions/common/groupLayers/allocateLayersForContrast.html" class="code" title="function     thisContrastLayers = allocateLayersForContrast(contrastLayers,outParameterisedLayers,useImaginary)">allocateLayersForContrast</a>(domainContrastLayers{1},outParameterisedLayers,useImaginary);
0114     thisContrastLayers2 = <a href="../../../targetFunctions/common/groupLayers/allocateLayersForContrast.html" class="code" title="function     thisContrastLayers = allocateLayersForContrast(contrastLayers,outParameterisedLayers,useImaginary)">allocateLayersForContrast</a>(domainContrastLayers{2},outParameterisedLayers,useImaginary);
0115     
0116     <span class="comment">% For the other parameters, we extract the correct ones from the input</span>
0117     <span class="comment">% arrays</span>
0118     thisRough = params(1);      <span class="comment">% Substrate roughness is always first parameter for standard layers</span>
0119     thisRepeatLayers = repeatLayers{i};
0120     thisResample = resample(i);
0121     thisData = allData{i};
0122     thisDataPresent = dataPresent(i);
0123     thisDataLimits = dataLimits{i};
0124     thisSimLimits = simLimits{i};
0125     thisBacksType = backsType(i);
0126     
0127     <span class="comment">% Now call the core layers reflectivity calculation</span>
0128     <span class="comment">% In this case we are single cored, so we do not parallelise over</span>
0129     <span class="comment">% points</span>
0130     <a href="parallelPoints.html" class="code" title="function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,domainSldProfiles,allLayers,allRoughs] = parallelPoints(problemDef,problemDefCells,controls)">parallelPoints</a> = <span class="string">'single'</span>;
0131     
0132     <span class="comment">% Call the core layers calculation - need to do this once for each</span>
0133     <span class="comment">% domain</span>
0134     [sldProfile1,reflect1,Simul1,shifted_dat,layerSld1,resamLayers1,~,thisSsubs]= nonPolarisedTF.coreLayersCalculation(thisContrastLayers1, thisRough, <span class="keyword">...</span>
0135     geometry, thisBulkIn, thisBulkOut, thisResample, calcSld, thisScalefactor, thisQzshift,<span class="keyword">...</span>
0136     thisDataPresent, thisData, thisDataLimits, thisSimLimits, thisRepeatLayers,<span class="keyword">...</span>
0137     thisBackground,thisResol,thisBacksType,nParams,<a href="parallelPoints.html" class="code" title="function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,domainSldProfiles,allLayers,allRoughs] = parallelPoints(problemDef,problemDefCells,controls)">parallelPoints</a>,resamPars,useImaginary);
0138 
0139     [sldProfile2,reflect2,Simul2,~,layerSld2,resamLayers2,~,~] = nonPolarisedTF.coreLayersCalculation(thisContrastLayers2, thisRough, <span class="keyword">...</span>
0140     geometry, thisBulkIn, thisBulkOut, thisResample, calcSld, thisScalefactor, thisQzshift,<span class="keyword">...</span>
0141     thisDataPresent, thisData, thisDataLimits, thisSimLimits, thisRepeatLayers,<span class="keyword">...</span>
0142     thisBackground,thisResol,thisBacksType,nParams,<a href="parallelPoints.html" class="code" title="function [outSsubs,backgs,qzshifts,scalefactors,bulkIns,bulkOuts,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,domainSldProfiles,allLayers,allRoughs] = parallelPoints(problemDef,problemDefCells,controls)">parallelPoints</a>,resamPars,useImaginary);
0143 
0144     <span class="comment">% Calculate the average reflectivities....</span>
0145     [totReflect,totSimul] = domainsTF.averageReflectivity(reflect1,reflect2,Simul1,Simul2,domainRatio);
0146 
0147     <span class="comment">% Get an overall chi-squared for the new averaged curve..</span>
0148     thisChiSquared = <a href="../../../targetFunctions/common/costFunctions/chiSquared.html" class="code" title="function chi2 = chiSquared(thisData,thisFit,P)">chiSquared</a>(shifted_dat,totReflect,length(params));
0149 
0150     <span class="comment">% Store returned values for this contrast in the output arrays.</span>
0151     <span class="comment">% As well as the calculated profiles, we also store a record of</span>
0152     <span class="comment">% the other values (background, scalefactors etc) for each contrast</span>
0153     <span class="comment">% for future use.</span>
0154     outSsubs(i) = thisSsubs;
0155     tempSldProfiles{i} = {sldProfile1, sldProfile2};
0156     reflectivity{i} = totReflect;
0157     Simulation{i} = totSimul;
0158     shifted_data{i} = shifted_dat;
0159     tempLayerSlds{i} = {layerSld1, layerSld2};
0160     tempAllLayers{i} = {resamLayers1, resamLayers2};
0161     
0162     chis(i) = thisChiSquared;
0163     backgs(i) = thisBackground;
0164     qzshifts(i) = thisQzshift;
0165     scalefactors(i) = thisScalefactor;
0166     bulkIns(i) = thisBulkIn;
0167     bulkOuts(i) = thisBulkOut;
0168     resols(i) = thisResol;
0169     allRoughs(i) = thisRough;
0170 <span class="keyword">end</span>
0171 
0172 <span class="keyword">for</span> i = 1:numberOfContrasts
0173     theseDomainSLDs = tempSldProfiles{i};
0174     domainSldProfiles{i,1} = theseDomainSLDs{1};
0175     domainSldProfiles{i,2} = theseDomainSLDs{2};
0176 
0177     theseAllLayers = tempAllLayers{i};
0178     allLayers{i,1} = theseAllLayers{1};
0179     allLayers{i,2} = theseAllLayers{2};
0180 
0181     theseLayerSlds = tempLayerSlds{i};
0182     layerSlds{i,1} = theseLayerSlds{1};
0183     layerSlds{i,2} = theseLayerSlds{2};
0184 <span class="keyword">end</span>
0185 <span class="keyword">end</span>
</pre></div>

<hr><address>Generated on Mon 04-Dec-2023 13:09:56 by <strong><a href="https://github.com/gllmflndn/m2html">m2html</a></strong> &copy; 2003-2022</address>
</body>
</html>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of standardLayers</title>
  <meta name="keywords" content="standardLayers">
  <meta name="description" content="This is the main reflectivity calculation of the standard layers">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003-2019 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html targetFunctions -->
<!-- menu.html +domainsTF -->

<h1>standardLayers
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>This is the main reflectivity calculation of the standard layers</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [backgroundParams,qzshifts,scalefactors,bulkIns,bulkOuts,resolutionParams,chis,reflectivity,simulation,shiftedData,domainLayerSlds,domainSldProfiles,domainResampledLayers,subRoughs] = standardLayers(problemStruct,problemCells,controls) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> This is the main reflectivity calculation of the standard layers
 calculation type. It extracts the required parameters for the contrasts
 from the input arrays, then passes the main calculation to
 'coreLayersCalculation', which carries out the calculation itself. 
 The core calculation is common for both standard and custom layers.
</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../targetFunctions/common/backSort.html" class="code" title="function [outBackgroundParam,outQzshift,outScalefactor,outBulkIn,outBulkOut,outResolutionParam] = backSort(contrastBackgrounds,contrastQzshifts,contrastScalefactors,contrastBulkIns,contrastBulkOuts,contrastResolutions,backgroundParams,qzshifts,scalefactors,bulkIn,bulkOut,resolutionParams)">backSort</a>	Distributes the background and shift values among the different contrasts</li>
<li><a href="../../targetFunctions/common/costFunctions/chiSquared.html" class="code" title="function chi2 = chiSquared(thisData,thisFit,P)">chiSquared</a>	Chi-squared function is used to evaluate the goodness of fit.</li>
<li><a href="../../targetFunctions/common/extractProblemParams.html" class="code" title="function [numberOfContrasts, geometry, contrastBackgrounds, contrastQzshifts, contrastScalefactors, contrastBulkIns, contrastBulkOuts,contrastResolutions, contrastDomainRatios, backgroundParams, qzshifts, scalefactors, bulkIn, bulkOut, resolutionParams, domainRatio,dataPresent, nParams, params, numberOfLayers, resample, contrastBackgroundActions, contrastCustomFiles, useImaginary] = extractProblemParams(problemStruct)">extractProblemParams</a>	Extract individual parameters from problem</li>
<li><a href="../../targetFunctions/common/groupLayers/allocateLayersForContrast.html" class="code" title="function     thisContrastLayers = allocateLayersForContrast(contrastLayers,outParameterisedLayers,useImaginary)">allocateLayersForContrast</a>	Decide which layers are needed for a particular contrast.</li>
<li><a href="../../targetFunctions/common/groupLayers/allocateParamsToLayers.html" class="code" title="function outLayers = allocateParamsToLayers(params, layersDetails)">allocateParamsToLayers</a>	Allocates parameters from the parameter array to the correct layers</li>
<li><a href="../../targetFunctions/common/parseCells.html" class="code" title="function [repeatLayers,data,dataLimits,simLimits,contrastLayers,layersDetails,customFiles] = parseCells(problemCells)">parseCells</a>	Splits up the master input list of all arrays into separate arrays</li>
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../targetFunctions/+nonPolarisedTF/standardLayers.html" class="code" title="function [backgroundParams,qzshifts,scalefactors,bulkIns,bulkOuts,...all">standardLayers</a>	</li>
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function [backgroundParamValue,qzshiftValue,scalefactorValue,bulkInValue,</a></li>
</ul>


<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [backgroundParams,qzshifts,scalefactors,bulkIns,bulkOuts,</a><span class="keyword">...</span>
0002     resolutionParams,chis,reflectivity,simulation,shiftedData,domainLayerSlds,<span class="keyword">...</span>
0003     domainSldProfiles,domainResampledLayers,subRoughs] = standardLayers(problemStruct,problemCells,controls)
0004     <span class="comment">% This is the main reflectivity calculation of the standard layers</span>
0005     <span class="comment">% calculation type. It extracts the required parameters for the contrasts</span>
0006     <span class="comment">% from the input arrays, then passes the main calculation to</span>
0007     <span class="comment">% 'coreLayersCalculation', which carries out the calculation itself.</span>
0008     <span class="comment">% The core calculation is common for both standard and custom layers.</span>
0009     
0010     <span class="comment">% Extract individual cell arrays</span>
0011     [repeatLayers,<span class="keyword">...</span>
0012      data,<span class="keyword">...</span>
0013      dataLimits,<span class="keyword">...</span>
0014      simLimits,~,<span class="keyword">...</span>
0015      layersDetails,~] = <a href="../../targetFunctions/common/parseCells.html" class="code" title="function [repeatLayers,data,dataLimits,simLimits,contrastLayers,layersDetails,customFiles] = parseCells(problemCells)">parseCells</a>(problemCells);
0016     
0017     <span class="comment">% Additionally extract the additional domain layers details</span>
0018     domainContrastLayers = problemCells{19};
0019     
0020     <span class="comment">% Extract individual parameters from problemStruct</span>
0021     [numberOfContrasts, geometry, contrastBackgroundIndices, contrastQzshiftIndices,<span class="keyword">...</span>
0022      contrastScalefactorIndices, contrastBulkInIndices, contrastBulkOutIndices,<span class="keyword">...</span>
0023      contrastResolutionIndices, contrastDomainRatioIndices, backgroundParamArray,<span class="keyword">...</span>
0024      qzshiftArray, scalefactorArray, bulkInArray, bulkOutArray, resolutionParamArray,<span class="keyword">...</span>
0025      domainRatioArray, dataPresent, nParams, params, ~, resample,<span class="keyword">...</span>
0026      contrastBackgroundActions, ~, useImaginary] = <a href="../../targetFunctions/common/extractProblemParams.html" class="code" title="function [numberOfContrasts, geometry, contrastBackgrounds, contrastQzshifts, contrastScalefactors, contrastBulkIns, contrastBulkOuts,contrastResolutions, contrastDomainRatios, backgroundParams, qzshifts, scalefactors, bulkIn, bulkOut, resolutionParams, domainRatio,dataPresent, nParams, params, numberOfLayers, resample, contrastBackgroundActions, contrastCustomFiles, useImaginary] = extractProblemParams(problemStruct)">extractProblemParams</a>(problemStruct);
0027     
0028     calcSld = controls.calcSldDuringFit;
0029     parallel = controls.parallel;
0030     resampleParams = controls.resampleParams;
0031     
0032     <span class="comment">% Allocate the memory for the output arrays before the main loop</span>
0033     backgroundParams = zeros(numberOfContrasts,1);
0034     qzshifts = zeros(numberOfContrasts,1);
0035     scalefactors = zeros(numberOfContrasts,1);
0036     bulkIns = zeros(numberOfContrasts,1);
0037     bulkOuts = zeros(numberOfContrasts,1);
0038     resolutionParams = zeros(numberOfContrasts,1);
0039     subRoughs = zeros(numberOfContrasts,1);
0040     chis = zeros(numberOfContrasts,1);
0041     domainLayerSlds = cell(numberOfContrasts,2);
0042     domainSldProfiles = cell(numberOfContrasts,2);
0043     shiftedData = cell(numberOfContrasts,1);
0044     
0045     reflectivity = cell(numberOfContrasts,1);
0046     <span class="keyword">for</span> i = 1:numberOfContrasts
0047         reflectivity{i} = [1 1; 1 1];
0048     <span class="keyword">end</span>
0049     
0050     simulation = cell(numberOfContrasts,1);
0051     <span class="keyword">for</span> i = 1:numberOfContrasts
0052         simulation{i} = [1 1; 1 1];
0053     <span class="keyword">end</span>
0054     
0055     domainResampledLayers = cell(numberOfContrasts,2);
0056     <span class="keyword">for</span> i = 1:numberOfContrasts
0057         domainResampledLayers{i,1} = [1 1 1; 1 1 1];
0058         domainResampledLayers{i,2} = [1 1 1; 1 1 1];
0059     <span class="keyword">end</span>
0060 
0061     domainContrastLayers1 = cell(numberOfContrasts,1);
0062     <span class="keyword">for</span> i = 1:numberOfContrasts
0063         domainContrastLayers1{i} = [1; 1];
0064     <span class="keyword">end</span>
0065     
0066     domainContrastLayers2 = cell(numberOfContrasts,1);
0067     <span class="keyword">for</span> i = 1:numberOfContrasts
0068         domainContrastLayers2{i} = [1; 1];
0069     <span class="keyword">end</span>
0070     
0071     sldProfiles = cell(numberOfContrasts,1);
0072     <span class="keyword">for</span> i = 1:numberOfContrasts
0073         sldProfiles{i} = {[1 1; 1 1],[1 1; 1 1]};
0074     <span class="keyword">end</span>
0075     
0076     resampledLayers = cell(numberOfContrasts,1);
0077     <span class="keyword">for</span> i = 1:numberOfContrasts
0078         resampledLayers{i} = {[1 1 1; 1 1 1],[1 1 1; 1 1 1]};
0079     <span class="keyword">end</span>
0080     
0081     layerSlds = cell(numberOfContrasts,1);
0082     <span class="keyword">for</span> i = 1:numberOfContrasts
0083         layerSlds{i} = {[1 1 1; 1 1 1],[1 1 1; 1 1 1]};
0084     <span class="keyword">end</span>
0085     <span class="comment">% end memory allocation.</span>
0086     
0087     <span class="comment">% First we need to allocate the absolute values of the input</span>
0088     <span class="comment">% parameters to all the layers in the layers list. This only needs</span>
0089     <span class="comment">% to be done once, and so is done outside the contrasts loop</span>
0090     outParameterisedLayers = <a href="../../targetFunctions/common/groupLayers/allocateParamsToLayers.html" class="code" title="function outLayers = allocateParamsToLayers(params, layersDetails)">allocateParamsToLayers</a>(params, layersDetails);
0091     
0092     <span class="comment">% Substrate roughness is always first parameter for standard layers</span>
0093     <span class="keyword">for</span> i = 1:numberOfContrasts
0094         subRoughs(i) = params(1);
0095     <span class="keyword">end</span>
0096 
0097     <span class="keyword">for</span> i = 1:size(domainContrastLayers1,1)
0098         domainContrastLayers1{i} = domainContrastLayers{i,1};
0099         domainContrastLayers2{i} = domainContrastLayers{i,2};
0100     <span class="keyword">end</span>
0101 
0102     <span class="keyword">if</span> strcmpi(parallel, coderEnums.parallelOptions.Contrasts)
0103     
0104         <span class="comment">% Loop over all the contrasts</span>
0105         parfor i = 1:numberOfContrasts
0106         
0107             [backgroundParams(i),qzshifts(i),scalefactors(i),bulkIns(i),<span class="keyword">...</span>
0108              bulkOuts(i),resolutionParams(i),chis(i),reflectivity{i},<span class="keyword">...</span>
0109              simulation{i},shiftedData{i},layerSlds{i},sldProfiles{i},<span class="keyword">...</span>
0110              resampledLayers{i}<span class="keyword">...</span>
0111              ] = contrastCalculation(contrastBackgroundIndices(i),<span class="keyword">...</span>
0112              contrastQzshiftIndices(i),contrastScalefactorIndices(i),<span class="keyword">...</span>
0113              contrastBulkInIndices(i),contrastBulkOutIndices(i),<span class="keyword">...</span>
0114              contrastResolutionIndices(i),contrastDomainRatioIndices(i),<span class="keyword">...</span>
0115              backgroundParamArray,qzshiftArray,scalefactorArray,bulkInArray,<span class="keyword">...</span>
0116              bulkOutArray,resolutionParamArray,domainRatioArray,dataPresent(i),<span class="keyword">...</span>
0117              data{i},dataLimits{i},simLimits{i},repeatLayers{i},<span class="keyword">...</span>
0118              contrastBackgroundActions(i),nParams,parallel,resampleParams,<span class="keyword">...</span>
0119              useImaginary,resample(i),geometry,subRoughs(i),calcSld,<span class="keyword">...</span>
0120              domainContrastLayers1{i},domainContrastLayers2{i},outParameterisedLayers);
0121     
0122         <span class="keyword">end</span>
0123     
0124     <span class="keyword">else</span>
0125     
0126         <span class="comment">% Loop over all the contrasts</span>
0127         <span class="keyword">for</span> i = 1:numberOfContrasts
0128 
0129             [backgroundParams(i),qzshifts(i),scalefactors(i),bulkIns(i),<span class="keyword">...</span>
0130              bulkOuts(i),resolutionParams(i),chis(i),reflectivity{i},<span class="keyword">...</span>
0131              simulation{i},shiftedData{i},layerSlds{i},sldProfiles{i},<span class="keyword">...</span>
0132              resampledLayers{i}<span class="keyword">...</span>
0133              ] = contrastCalculation(contrastBackgroundIndices(i),<span class="keyword">...</span>
0134              contrastQzshiftIndices(i),contrastScalefactorIndices(i),<span class="keyword">...</span>
0135              contrastBulkInIndices(i),contrastBulkOutIndices(i),<span class="keyword">...</span>
0136              contrastResolutionIndices(i),contrastDomainRatioIndices(i),<span class="keyword">...</span>
0137              backgroundParamArray,qzshiftArray,scalefactorArray,bulkInArray,<span class="keyword">...</span>
0138              bulkOutArray,resolutionParamArray,domainRatioArray,dataPresent(i),<span class="keyword">...</span>
0139              data{i},dataLimits{i},simLimits{i},repeatLayers{i},<span class="keyword">...</span>
0140              contrastBackgroundActions(i),nParams,parallel,resampleParams,<span class="keyword">...</span>
0141              useImaginary,resample(i),geometry,subRoughs(i),calcSld,<span class="keyword">...</span>
0142              domainContrastLayers1{i},domainContrastLayers2{i},outParameterisedLayers);
0143     
0144         <span class="keyword">end</span>
0145     
0146     <span class="keyword">end</span>
0147     
0148     <span class="keyword">for</span> i = 1:numberOfContrasts
0149     
0150         contrastSldProfiles = sldProfiles{i};
0151         domainSldProfiles{i,1} = contrastSldProfiles{1};
0152         domainSldProfiles{i,2} = contrastSldProfiles{2};
0153     
0154         contrastLayerSlds = layerSlds{i};
0155         domainLayerSlds{i,1} = contrastLayerSlds{1};
0156         domainLayerSlds{i,2} = contrastLayerSlds{2};
0157     
0158         contrastResampledLayers = resampledLayers{i};
0159         domainResampledLayers{i,1} = contrastResampledLayers{1};
0160         domainResampledLayers{i,2} = contrastResampledLayers{2};
0161     
0162     <span class="keyword">end</span>
0163 
0164 <span class="keyword">end</span>
0165 
0166 
0167 <a name="_sub1" href="#_subfunctions" class="code">function [backgroundParamValue,qzshiftValue,scalefactorValue,bulkInValue,</a><span class="keyword">...</span>
0168     bulkOutValue,resolutionParamValue,chi,reflectivity,simulation,shiftedData,<span class="keyword">...</span>
0169     layerSld,sldProfile,resampledLayer] = contrastCalculation(backgroundParamIndex,<span class="keyword">...</span>
0170     qzshiftIndex,scalefactorIndex,bulkInIndex,bulkOutIndex,resolutionParamIndex,<span class="keyword">...</span>
0171     domainRatioIndex,backgroundParams,qzshifts,scalefactors,bulkIns,bulkOuts,<span class="keyword">...</span>
0172     resolutionParams,domainRatios,dataPresent,data,dataLimits,simLimits,<span class="keyword">...</span>
0173     repeatLayers,contrastBackgroundActions,nParams,parallel,resampleParams,<span class="keyword">...</span>
0174     useImaginary,resample,geometry,roughness,calcSld,domainContrastLayers1,<span class="keyword">...</span>
0175     domainContrastLayers2,outParameterisedLayers)
0176 
0177     <span class="comment">% Get the domain ratio for this contrast</span>
0178     <span class="keyword">if</span> isempty(domainRatioIndex)
0179         domainRatioIndex = 1;
0180     <span class="keyword">end</span>
0181     domainRatio = domainRatios(domainRatioIndex);
0182 
0183     <span class="comment">% Extract the relevant parameter values for this contrast</span>
0184     <span class="comment">% from the input arrays.</span>
0185     <span class="comment">% First need to decide which values of the backgrounds, scalefactors</span>
0186     <span class="comment">% data shifts and bulk contrasts are associated with this contrast</span>
0187     [backgroundParamValue,qzshiftValue,scalefactorValue,bulkInValue,bulkOutValue,<span class="keyword">...</span>
0188      resolutionParamValue] = <a href="../../targetFunctions/common/backSort.html" class="code" title="function [outBackgroundParam,outQzshift,outScalefactor,outBulkIn,outBulkOut,outResolutionParam] = backSort(contrastBackgrounds,contrastQzshifts,contrastScalefactors,contrastBulkIns,contrastBulkOuts,contrastResolutions,backgroundParams,qzshifts,scalefactors,bulkIn,bulkOut,resolutionParams)">backSort</a>(backgroundParamIndex,qzshiftIndex,<span class="keyword">...</span>
0189      scalefactorIndex,bulkInIndex,bulkOutIndex,resolutionParamIndex,<span class="keyword">...</span>
0190      backgroundParams,qzshifts,scalefactors,bulkIns,bulkOuts,resolutionParams);
0191 
0192     <span class="comment">% Also need to determine which layers from the overall layers list</span>
0193     <span class="comment">% are required for this contrast, and put them in the correct order</span>
0194     <span class="comment">% according to geometry. We run it twice, once for each domain...</span>
0195     thisContrastLayers1 = <a href="../../targetFunctions/common/groupLayers/allocateLayersForContrast.html" class="code" title="function     thisContrastLayers = allocateLayersForContrast(contrastLayers,outParameterisedLayers,useImaginary)">allocateLayersForContrast</a>(domainContrastLayers1,outParameterisedLayers,useImaginary);
0196     thisContrastLayers2 = <a href="../../targetFunctions/common/groupLayers/allocateLayersForContrast.html" class="code" title="function     thisContrastLayers = allocateLayersForContrast(contrastLayers,outParameterisedLayers,useImaginary)">allocateLayersForContrast</a>(domainContrastLayers2,outParameterisedLayers,useImaginary);
0197        
0198     <span class="comment">% Call the core layers calculation - need to do this once for each</span>
0199     <span class="comment">% domain</span>
0200     [sldProfile1,reflect1,simul1,shiftedData,layerSld1,resampledLayer1,~] = nonPolarisedTF.coreLayersCalculation(thisContrastLayers1,roughness,<span class="keyword">...</span>
0201      geometry,bulkInValue,bulkOutValue,resample,calcSld,scalefactorValue,qzshiftValue,<span class="keyword">...</span>
0202      dataPresent,data,dataLimits,simLimits,repeatLayers,backgroundParamValue,<span class="keyword">...</span>
0203      resolutionParamValue,contrastBackgroundActions,nParams,parallel,resampleParams,useImaginary);
0204 
0205     [sldProfile2,reflect2,simul2,~,layerSld2,resampledLayer2,~] = nonPolarisedTF.coreLayersCalculation(thisContrastLayers2,roughness,<span class="keyword">...</span>
0206      geometry,bulkInValue,bulkOutValue,resample,calcSld,scalefactorValue,qzshiftValue,<span class="keyword">...</span>
0207      dataPresent,data,dataLimits,simLimits,repeatLayers,backgroundParamValue,<span class="keyword">...</span>
0208      resolutionParamValue,contrastBackgroundActions,nParams,parallel,resampleParams,useImaginary);
0209     
0210     <span class="comment">% Calculate the average reflectivities....</span>
0211     [reflectivity,simulation] = domainsTF.averageReflectivity(reflect1,reflect2,simul1,simul2,domainRatio);
0212 
0213     <span class="comment">% Get an overall chi-squared for the new averaged curve..</span>
0214     chi = <a href="../../targetFunctions/common/costFunctions/chiSquared.html" class="code" title="function chi2 = chiSquared(thisData,thisFit,P)">chiSquared</a>(shiftedData,reflectivity,nParams);
0215 
0216     <span class="comment">% Store returned values for this contrast in the output arrays.</span>
0217     sldProfile = {sldProfile1, sldProfile2};
0218     layerSld = {layerSld1, layerSld2};
0219     resampledLayer = {resampledLayer1, resampledLayer2};
0220 
0221 <span class="keyword">end</span>
</pre></div>

<hr><address>Generated on Wed 05-Jun-2024 09:06:47 by <strong><a href="https://github.com/gllmflndn/m2html">m2html</a></strong> &copy; 2003-2022</address>
</body>
</html>

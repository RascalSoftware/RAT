<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of domainsTFStandardLayersSingle</title>
  <meta name="keywords" content="domainsTFStandardLayersSingle">
  <meta name="description" content="Single threaded version of the Standard Layers calculation">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2003-2019 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- # targetFunctions -->
<!-- ../menu.html domainsTF -->
<!-- menu.html standardLayers -->

<h1>domainsTFStandardLayersSingle
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>Single threaded version of the Standard Layers calculation</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function [outSsubs,backgs,qshifts,sfs,nbas,nbss,resols,chis,reflectivity,Simulation,shifted_data,layerSlds,domainSldProfiles,allLayers,allRoughs] = domainsTFStandardLayersSingle(problemDef,problemDefCells,problemDefLimits,controls) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment"> Single threaded version of the Standard Layers calculation 
 This is the main reflectivity calculation of the standard layers
 calculation type. It extracts the required parameters for the contrasts
 from the input arrays, then passes the main calculation to
 'standardLayersCore', which carries out the calculation itself. 
 The core calculation is common for both standard and custom layers.
</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../API/extractProblemParams.html" class="code" title="function [numberOfContrasts, geometry, cBacks, cShifts, cScales, cNbas, cNbss,cRes, backs, shifts, sf, nba, nbs, res, dataPresent, nParams, params,numberOfLayers, resample, backsType, cFiles] =  extractProblemParams(problemDef)">extractProblemParams</a>	Extract individual parameters from problemDef</li>
<li><a href="../../../API/parseCells.html" class="code" title="function [repeatLayers,allData,dataLimits,simLimits,contrastLayers,layersDetails,customFiles] = parseCells(problemDefCells)">parseCells</a>	Splits up the master input list of all arrays into separate arrays</li>
<li><a href="../../../targetFunctions/common/backSort/backSort.html" class="code" title="function [backg,qshift,sf,nba,nbs,resol] = backSort(cBacks,cShifts,cScales,cNbas,cNbss,cRes,backs,shifts,sf,nba,nbs,res)">backSort</a>	Distributes the background and shift values among the different contrasts</li>
<li><a href="../../../targetFunctions/common/costFunctions/chiSquared/chiSquared.html" class="code" title="function chi2 = chiSquared(thisData,thisFit,P)">chiSquared</a>	Chi-squared function is used to evaluate the goodness of fit.</li>
<li><a href="../../../targetFunctions/common/groupLayers/allocateLayersForContrast.html" class="code" title="function     thisContrastLayers = allocateLayersForContrast(contrastLayers,outParameterisedLayers,useImaginary)">allocateLayersForContrast</a>	Decide which layers are needed for a particular contrast.</li>
<li><a href="../../../targetFunctions/common/groupLayers/allocateParamsToLayers.html" class="code" title="function outLayers = allocateParamsToLayers(params, layersDetails)">allocateParamsToLayers</a>	Allocates parameters from the parameter array to the correct layers</li>
<li><a href="../../../targetFunctions/domainsTF/averageReflectivity.html" class="code" title="function [totReflect,totSimul] = averageReflectivity(reflect1,reflect2,Simul1,Simul2,domainRatio)">averageReflectivity</a>	Calculates the avereaged reflectivity for domains samples (incoherent</li>
<li><a href="../../../targetFunctions/standardTF/standardTFLayersCore.html" class="code" title="function [sldProfile,reflect,Simul,shifted_dat,theseLayers,resamLayers,chiSq,ssubs] =standardTFLayersCore(contrastLayers, rough,geometry, nba, nbs, resample, calcSld, sf, qshift,dataPresent, data, dataLimits, simLimits, repeatLayers,background,resol,backsType,params,parallelPoints,resamPars,useImaginary)">standardTFLayersCore</a>	This is the main reflectivity calculation for all Layers models in the</li>
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../targetFunctions/domainsTF/domainsTFStandardLayersReflectivityCalculation.html" class="code" title="function [problem,reflectivity,Simulation,shifted_data,layerSlds,sldProfiles,allLayers] = domainsTFStandardLayersReflectivityCalculation(problemDef,problemDefCells,problemDefLimits,controls)">domainsTFStandardLayersReflectivityCalculation</a>	Standard layers reflectivity calculation for standardTF</li>
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 
0002 <a name="_sub0" href="#_subfunctions" class="code">function [outSsubs,backgs,qshifts,sfs,nbas,nbss,resols,chis,reflectivity,</a><span class="keyword">...</span>
0003     Simulation,shifted_data,layerSlds,domainSldProfiles,allLayers,<span class="keyword">...</span>
0004     allRoughs] = domainsTFStandardLayersSingle(problemDef,problemDefCells,<span class="keyword">...</span>
0005     problemDefLimits,controls)
0006 <span class="comment">% Single threaded version of the Standard Layers calculation</span>
0007 <span class="comment">% This is the main reflectivity calculation of the standard layers</span>
0008 <span class="comment">% calculation type. It extracts the required parameters for the contrasts</span>
0009 <span class="comment">% from the input arrays, then passes the main calculation to</span>
0010 <span class="comment">% 'standardLayersCore', which carries out the calculation itself.</span>
0011 <span class="comment">% The core calculation is common for both standard and custom layers.</span>
0012 
0013 
0014 <span class="comment">% Extract individual cell arrays</span>
0015 [repeatLayers,<span class="keyword">...</span>
0016  allData,<span class="keyword">...</span>
0017  dataLimits,<span class="keyword">...</span>
0018  simLimits,~,<span class="keyword">...</span>
0019  layersDetails,~] = <a href="../../../API/parseCells.html" class="code" title="function [repeatLayers,allData,dataLimits,simLimits,contrastLayers,layersDetails,customFiles] = parseCells(problemDefCells)">parseCells</a>(problemDefCells);
0020 
0021 <span class="comment">% Additionally extract the additional domain layers details</span>
0022 domainContrastLayers = problemDefCells{19};
0023 
0024 <span class="comment">% Extract individual parameters from problemDef struct</span>
0025 [numberOfContrasts, geometry, cBacks, cShifts, cScales, cNbas, cNbss,<span class="keyword">...</span>
0026 cRes, backs, shifts, sf, nba, nbs, res, dataPresent, nParams, params,<span class="keyword">...</span>
0027 numberOfLayers, resample, backsType, ~] =  <a href="../../../API/extractProblemParams.html" class="code" title="function [numberOfContrasts, geometry, cBacks, cShifts, cScales, cNbas, cNbss,cRes, backs, shifts, sf, nba, nbs, res, dataPresent, nParams, params,numberOfLayers, resample, backsType, cFiles] =  extractProblemParams(problemDef)">extractProblemParams</a>(problemDef);
0028 
0029 calcSld = controls.calcSldDuringFit;   
0030 useImaginary = problemDef.useImaginary;
0031 allDomainRatios = problemDef.domainRatio;
0032 contrastDomainRatios = problemDef.contrastDomainRatios;
0033 
0034 domainRatio = 1;    <span class="comment">% Default for compile.</span>
0035 
0036 <span class="comment">% Allocate the memory for the output arrays before the main loop</span>
0037 backgs = zeros(numberOfContrasts,1);
0038 qshifts = zeros(numberOfContrasts,1);
0039 sfs = zeros(numberOfContrasts,1);
0040 nbas = zeros(numberOfContrasts,1);
0041 nbss = zeros(numberOfContrasts,1);
0042 resols = zeros(numberOfContrasts,1);
0043 allRoughs = zeros(numberOfContrasts,1);
0044 outSsubs = zeros(numberOfContrasts,1);
0045 chis =  zeros(numberOfContrasts,1);
0046 layerSlds = cell(numberOfContrasts,2);
0047 domainSldProfiles = cell(numberOfContrasts,2);
0048 shifted_data = cell(numberOfContrasts,1);
0049 
0050 reflectivity = cell(numberOfContrasts,1);
0051 <span class="keyword">for</span> i = 1:numberOfContrasts
0052     reflectivity{i} = [1 1 ; 1 1];
0053 <span class="keyword">end</span>
0054 
0055 Simulation = cell(numberOfContrasts,1);
0056 <span class="keyword">for</span> i = 1:numberOfContrasts
0057     Simulation{i} = [1 1 ; 1 1];
0058 <span class="keyword">end</span>
0059 
0060 allLayers = cell(numberOfContrasts,2);
0061 <span class="keyword">for</span> i = 1:numberOfContrasts
0062     allLayers{i,1} = [1 1 1; 1 1 1];
0063     allLayers{i,2} = [1 1 1; 1 1 1];
0064 <span class="keyword">end</span>
0065 
0066 tempSldProfiles = cell(numberOfContrasts,1);
0067 <span class="keyword">for</span> i = 1:numberOfContrasts
0068     tempSldProfiles{i} = {[1 1 ; 1 1],[1 1 ; 1 1]};
0069 <span class="keyword">end</span>
0070 
0071 calcAllLayers = cell(numberOfContrasts,2);
0072 <span class="keyword">for</span> i = 1:numberOfContrasts
0073     calcAllLayers{i,1} = [1 ; 1];
0074     calcAllLayers{i,2} = [1 ; 1];
0075 <span class="keyword">end</span>
0076 
0077 tempAllLayers = cell(numberOfContrasts,1);
0078 <span class="keyword">for</span> i = 1:numberOfContrasts
0079     tempAllLayers{i} = {[1 1 1;1 1 1],[1 1 1;1 1 1]};
0080 <span class="keyword">end</span>
0081 
0082 tempLayerSlds = cell(numberOfContrasts,1);
0083 <span class="keyword">for</span> i = 1:numberOfContrasts
0084     tempLayerSlds{i} = {[1 1 1;1 1 1],[1 1 1;1 1 1]};
0085 <span class="keyword">end</span>
0086 <span class="comment">% end memory allocation.</span>
0087 
0088 <span class="comment">% First we need to allocate the absolute values of the input</span>
0089 <span class="comment">% parameters to all the layers in the layers list. This only needs</span>
0090 <span class="comment">% to be done once, and so is done outside the contrasts loop</span>
0091 outParameterisedLayers = <a href="../../../targetFunctions/common/groupLayers/allocateParamsToLayers.html" class="code" title="function outLayers = allocateParamsToLayers(params, layersDetails)">allocateParamsToLayers</a>(params, layersDetails);
0092 
0093 <span class="comment">% Resample params if requiired</span>
0094 resamPars = controls.resamPars;
0095 
0096 <span class="comment">% Loop over all the contrasts</span>
0097 <span class="keyword">for</span> i = 1:numberOfContrasts
0098 
0099     <span class="comment">% Get the domain ratio for this contrast</span>
0100     thisContrastDR = contrastDomainRatios(i);
0101     <span class="keyword">if</span> isempty(thisContrastDR)
0102         thisContrastDR = 1;
0103     <span class="keyword">end</span>
0104     domainRatio = allDomainRatios(thisContrastDR);
0105 
0106     <span class="comment">% Extract the relevant parameter values for this contrast</span>
0107     <span class="comment">% from the input arrays.</span>
0108     <span class="comment">% First need to decide which values of the backgrounds, scalefactors</span>
0109     <span class="comment">% data shifts and bulk contrasts are associated with this contrast</span>
0110     [thisBackground,thisQshift,thisSf,thisNba,thisNbs,thisResol] = <a href="../../../targetFunctions/common/backSort/backSort.html" class="code" title="function [backg,qshift,sf,nba,nbs,resol] = backSort(cBacks,cShifts,cScales,cNbas,cNbss,cRes,backs,shifts,sf,nba,nbs,res)">backSort</a>(cBacks(i),cShifts(i),cScales(i),cNbas(i),cNbss(i),cRes(i),backs,shifts,sf,nba,nbs,res);
0111     
0112     <span class="comment">% Also need to determine which layers from the overall layers list</span>
0113     <span class="comment">% are required for this contrast, and put them in the correct order</span>
0114     <span class="comment">% according to geometry. We run it twice, once for each domain...</span>
0115     thisContrastLayers1 = <a href="../../../targetFunctions/common/groupLayers/allocateLayersForContrast.html" class="code" title="function     thisContrastLayers = allocateLayersForContrast(contrastLayers,outParameterisedLayers,useImaginary)">allocateLayersForContrast</a>(domainContrastLayers{1},outParameterisedLayers,useImaginary);
0116     thisContrastLayers2 = <a href="../../../targetFunctions/common/groupLayers/allocateLayersForContrast.html" class="code" title="function     thisContrastLayers = allocateLayersForContrast(contrastLayers,outParameterisedLayers,useImaginary)">allocateLayersForContrast</a>(domainContrastLayers{2},outParameterisedLayers,useImaginary);
0117     
0118     <span class="comment">% For the other parameters, we extract the correct ones from the input</span>
0119     <span class="comment">% arrays</span>
0120     thisRough = params(1);      <span class="comment">% Substrate roughness is always first parameter for standard layers</span>
0121     thisRepeatLayers = repeatLayers{i};
0122     thisResample = resample(i);
0123     thisData = allData{i};
0124     thisDataPresent = dataPresent(i);
0125     thisDataLimits = dataLimits{i};
0126     thisSimLimits = simLimits{i};
0127     thisBacksType = backsType(i);
0128     
0129     <span class="comment">% Now call the core standardTF_stanlay reflectivity calculation</span>
0130     <span class="comment">% In this case we are single cored, so we do not parallelise over</span>
0131     <span class="comment">% points</span>
0132     parallelPoints = <span class="string">'single'</span>;
0133     
0134     <span class="comment">% Call the core layers calculation - need to do this once for each</span>
0135     <span class="comment">% domain</span>
0136     [sldProfile1,reflect1,Simul1,shifted_dat,layerSld1,resamLayers1,~,thisSsubs]= <a href="../../../targetFunctions/standardTF/standardTFLayersCore.html" class="code" title="function [sldProfile,reflect,Simul,shifted_dat,theseLayers,resamLayers,chiSq,ssubs] =standardTFLayersCore(contrastLayers, rough,geometry, nba, nbs, resample, calcSld, sf, qshift,dataPresent, data, dataLimits, simLimits, repeatLayers,background,resol,backsType,params,parallelPoints,resamPars,useImaginary)">standardTFLayersCore</a>(thisContrastLayers1, thisRough, <span class="keyword">...</span>
0137     geometry, thisNba, thisNbs, thisResample, calcSld, thisSf, thisQshift,<span class="keyword">...</span>
0138     thisDataPresent, thisData, thisDataLimits, thisSimLimits, thisRepeatLayers,<span class="keyword">...</span>
0139     thisBackground,thisResol,thisBacksType,nParams,parallelPoints,resamPars,useImaginary);
0140 
0141     [sldProfile2,reflect2,Simul2,~,layerSld2,resamLayers2,~,~] = <a href="../../../targetFunctions/standardTF/standardTFLayersCore.html" class="code" title="function [sldProfile,reflect,Simul,shifted_dat,theseLayers,resamLayers,chiSq,ssubs] =standardTFLayersCore(contrastLayers, rough,geometry, nba, nbs, resample, calcSld, sf, qshift,dataPresent, data, dataLimits, simLimits, repeatLayers,background,resol,backsType,params,parallelPoints,resamPars,useImaginary)">standardTFLayersCore</a>(thisContrastLayers2, thisRough, <span class="keyword">...</span>
0142     geometry, thisNba, thisNbs, thisResample, calcSld, thisSf, thisQshift,<span class="keyword">...</span>
0143     thisDataPresent, thisData, thisDataLimits, thisSimLimits, thisRepeatLayers,<span class="keyword">...</span>
0144     thisBackground,thisResol,thisBacksType,nParams,parallelPoints,resamPars,useImaginary);
0145 
0146     <span class="comment">% Calculate the average reflectivities....</span>
0147     [totReflect,totSimul] = <a href="../../../targetFunctions/domainsTF/averageReflectivity.html" class="code" title="function [totReflect,totSimul] = averageReflectivity(reflect1,reflect2,Simul1,Simul2,domainRatio)">averageReflectivity</a>(reflect1,reflect2,Simul1,Simul2,domainRatio);
0148 
0149     <span class="comment">% Get an overall chi-squared for the new averaged curve..</span>
0150     thisChiSquared = <a href="../../../targetFunctions/common/costFunctions/chiSquared/chiSquared.html" class="code" title="function chi2 = chiSquared(thisData,thisFit,P)">chiSquared</a>(shifted_dat,totReflect,length(params));
0151 
0152     <span class="comment">% Store returned values for this contrast in the output arrays.</span>
0153     <span class="comment">% As well as the calculated profiles, we also store a record of</span>
0154     <span class="comment">% the other values (background, scalefactors etc) for each contrast</span>
0155     <span class="comment">% for future use.</span>
0156     outSsubs(i) = thisSsubs;
0157     tempSldProfiles{i} = {sldProfile1, sldProfile2};
0158     reflectivity{i} = totReflect;
0159     Simulation{i} = totSimul;
0160     shifted_data{i} = shifted_dat;
0161     tempLayerSlds{i} = {layerSld1, layerSld2};
0162     tempAllLayers{i} = {resamLayers1, resamLayers2};
0163     
0164     chis(i) = thisChiSquared;
0165     backgs(i) = thisBackground;
0166     qshifts(i) = thisQshift;
0167     sfs(i) = thisSf;
0168     nbas(i) = thisNba;
0169     nbss(i) = thisNbs;
0170     resols(i) = thisResol;
0171     allRoughs(i) = thisRough;
0172 <span class="keyword">end</span>
0173 
0174 <span class="keyword">for</span> i = 1:numberOfContrasts
0175     theseDomainSLDs = tempSldProfiles{i};
0176     domainSldProfiles{i,1} = theseDomainSLDs{1};
0177     domainSldProfiles{i,2} = theseDomainSLDs{2};
0178 
0179     theseAllLayers = tempAllLayers{i};
0180     allLayers{i,1} = theseAllLayers{1};
0181     allLayers{i,2} = theseAllLayers{2};
0182 
0183     theseLayerSlds = tempLayerSlds{i};
0184     layerSlds{i,1} = theseLayerSlds{1};
0185     layerSlds{i,2} = theseLayerSlds{2};
0186 <span class="keyword">end</span>
0187 
0188 <span class="keyword">end</span>
0189 
0190 
</pre></div>

<hr><address>Generated on Tue 14-Nov-2023 16:00:59 by <strong><a href="https://github.com/gllmflndn/m2html">m2html</a></strong> &copy; 2003-2022</address>
</body>
</html>

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Developer Documentation &mdash; RAT 0.1.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
        <script src="_static/design-tabs.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="about.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Architectural Decision Records" href="ADR.html" />
    <link rel="prev" title="Target Functions" href="targetFunctions.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> RAT
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">RAT Tutorial</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="sourceCodeLayout.html">Source Code Layout</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l2"><a class="reference internal" href="targetFunctions.html">Target Functions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Developer Documentation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#unit-testing">Unit Testing</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#custom-layers-functionality">Custom Layers Functionality</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-does-c-custom-model-work">How does C++ custom model work?</a></li>
<li class="toctree-l4"><a class="reference internal" href="#how-to-create-a-custom-c-model">How to create a custom C++ model</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#additional-documentation">Additional Documentation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#dependency-graph">Dependency Graph</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#devops">DevOps</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#jenkins">Jenkins</a></li>
<li class="toctree-l4"><a class="reference internal" href="#stfc-cloud">STFC Cloud</a></li>
<li class="toctree-l4"><a class="reference internal" href="#work-flow">Work Flow</a></li>
<li class="toctree-l4"><a class="reference internal" href="#references-for-developers">References for Developers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ADR.html">Architectural Decision Records</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="userDocumentation.html">User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">Support</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About RAT</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">RAT</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="sourceCodeLayout.html">Source Code Layout</a></li>
      <li class="breadcrumb-item active">Developer Documentation</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/devDocumentation.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="developer-documentation">
<span id="devdocs"></span><h1>Developer Documentation<a class="headerlink" href="#developer-documentation" title="Permalink to this heading"></a></h1>
<p>This documentation is intended towards developers who wish to understand how RAT’s core workflow works and all the different components of the software.
The following picture shows the core workflow of RAT.</p>
<img alt="RAT's core workflow" src="_images/toolbox.png" />
<section id="unit-testing">
<h2>Unit Testing<a class="headerlink" href="#unit-testing" title="Permalink to this heading"></a></h2>
<p>Unit Testing is the process of testing multiple individual pieces/features of the software. It helps to find bugs easily and quickly since each individual feature is tested
independently.</p>
<p>RAT’s unit tests are written in MATLAB using <code class="code docutils literal notranslate"><span class="pre">matlab.unittest</span></code> framework.
These unit tests are written to test the following set of functions:</p>
<ol class="arabic simple">
<li><p><a class="reference internal" href="targetFunctions.html#commonfunctions"><span class="std std-ref">Common Functions</span></a></p></li>
<li><p><a class="reference internal" href="targetFunctions.html#standardtf-reflectivitycalculation"><span class="std std-ref">Standard Target Functions (StandardTF)</span></a></p></li>
<li><p><a class="reference internal" href="api.html#projectclass"><span class="std std-ref">Project Class</span></a></p></li>
<li><p><a class="reference internal" href="api.html#controlsdef"><span class="std std-ref">ControlsDef</span></a></p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All the common function tests compare the <strong>stable output</strong> against the <strong>on-demand output</strong> of a function. This is done to make sure that the current function is behaving
as expected. On the contrary, all the standard_TF tests compare the MATLAB output against the MEX output. This is done to make sure and catch any unseen errors during
compiling the MEX file by MATLAB Coder.</p>
</div>
<p><strong>Stable output</strong> = This is the output of a certain function obtained when the function is working as expected.</p>
<p><strong>On-demand output</strong> = This is the output of a certain function at the moment. So, that current function can be tested against the stable one.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Despite tests being written in MATLAB, RAT’s unit tests also test the C++ code of RAT in a way.
This is achieved through comparing the outputs of mex and matlab versions of all the possible parallelization of standardTF_reflectivityCalculation.
This includes the following:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>standardTF_customLayers (Single,Points and Contrast)</p></li>
<li><p>standard_TF_customXY (Single,Points and Contrast)</p></li>
<li><p>standardTF_standardLayers (Single,Points and Contrast)</p></li>
</ol>
</div></blockquote>
</div>
<section id="custom-layers-functionality">
<h3>Custom Layers Functionality<a class="headerlink" href="#custom-layers-functionality" title="Permalink to this heading"></a></h3>
<p>RAT allows users to create their own custom models and use them in the reflectivity calculations. RAT currently supports C++ and MATLAB custom models meaning users can upload
their model in the form of a function in MATLAB. However, there is a slight complication with the C++.</p>
<p>In order, to use the custom C++ model, the user needs to compile the function into a shared library (preferably using GCC) and then provide the path and name of the function inside the shared library to RAT.
The following guide will help the user to do this.</p>
</section>
<section id="how-does-c-custom-model-work">
<h3>How does C++ custom model work?<a class="headerlink" href="#how-does-c-custom-model-work" title="Permalink to this heading"></a></h3>
<p>The implementation of the custom C++ model functionality is bit complicated but the idea is simple. For sake of explanation, DLL and dynamic library are interchangeably used here.</p>
<ol class="arabic">
<li><p>The user submits a DLL file that has the custom C++ model in the form of a function. Our job is to get that function so we can run with the arguments from RAT. In order to <em>get</em>
the file we used an open-source project called <a class="reference external" href="https://github.com/martin-olivier/dylib/">dylib</a>. dylib helps us extract the function from the DLL at runtime which means we can use the function at runtime.</p></li>
<li><p>When the users makes the DLL, they put the <em>DYLIB_API</em> macro at the beginning of the function which exports the function.</p></li>
<li><p>There is a class called <em>libManager.h</em> in <em>RAT/targetFunctions/common/loopCppCustlayWrapper</em> directory which opens a DLL and extracts the function when given the
path to the DLL. Then runs the function with the arguments from RAT. This the C++ side of the implementation</p></li>
<li><p>We need a gateway that allows MATLAB inputs to go into the C++ side of the code. This is done by creating a MEX function using MATLAB Coder. The file <em>testDLL.m</em> is compiled by
Matlab Coder.</p>
<p>This file basically passes the inputs from MATLAB Workspace to the function from <em>libManager.h</em> which runs those inputs/arguments on the function from the DLL.</p>
</li>
<li><p>As soon the we pass and compute the results comeback into the MATLAB workspace.</p></li>
</ol>
<p>The above explanation holds true for the case of MATLAB version of RAT. If this feature is being used in the compiled version of RAT (i.e setting reflectivity_calculation_wrapper case to <strong>mex</strong>),
there’s a case statement that will treat testDLL_mex as an extrinsic function and not a MEX function as per the guidelines of MATLAB Coder.</p>
</section>
<section id="how-to-create-a-custom-c-model">
<h3>How to create a custom C++ model<a class="headerlink" href="#how-to-create-a-custom-c-model" title="Permalink to this heading"></a></h3>
<p>1. First Step is to make sure your cpp file is error-free and follow the guidelines mentioned in this step. Your cpp file should contain your custom model and
custom model should be a function. In order for RAT to fetch your custom model/function, it needs to be exported. So, you have to get <a class="reference external" href="https://github.com/martin-olivier/dylib/releases/download/v1.8.2/dylib.hpp">dylib.hpp</a> here and put <strong>DYLIB_API</strong>
macro in front of the function name.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">DYLIB_API</span> <span class="n">void</span> <span class="n">myCustomFunction</span><span class="p">(</span><span class="n">double</span> <span class="o">*</span><span class="n">params</span><span class="o">...</span><span class="n">etc</span><span class="o">....</span><span class="p">)</span>
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Now that you have put DYLIB_API in front of the dependencies. It is time to make a dynamic library of your model. To do this, you must follow platform specific instructions below.</p></li>
</ol>
<p>Lets say your file is called <strong>myModel.cpp</strong> and your function is called <strong>myCustomFunction</strong></p>
<details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
How to compile a shared library on Windows<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text"><strong>Windows - DLL</strong></p>
<p class="sd-card-text"><strong>Prerequisites</strong>: MinGW or Microsoft Visual Studio Compiler (MSVC) but GCC is strongly suggested</p>
<p class="sd-card-text"><strong>GCC</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>g++<span class="w"> </span>-c<span class="w"> </span>myModel.cpp<span class="w"> </span>-o<span class="w"> </span>myModel.o<span class="w">   </span>Generate<span class="w"> </span>an<span class="w"> </span>object<span class="w"> </span>file
g++<span class="w"> </span>-shared<span class="w"> </span>myModel.o<span class="w"> </span>-o<span class="w"> </span>myModel.dll<span class="w">  </span>outputs<span class="w"> </span>a<span class="w"> </span>DLL<span class="w"> </span>named<span class="w"> </span>myModel.dll
</pre></div>
</div>
<p class="sd-card-text"><strong>MSVC (Microsoft Visual Studio Compiler)</strong></p>
<p class="sd-card-text">Open <em>Developer Command Prompt for Visual Studio</em></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cl.exe<span class="w"> </span>/LD<span class="w"> </span>myModel.cpp<span class="w"> </span>/EHsc<span class="w">   </span>You<span class="w"> </span>should<span class="w"> </span>see<span class="w"> </span>myModel.dll<span class="w"> </span><span class="k">in</span><span class="w"> </span>the<span class="w"> </span>current<span class="w"> </span>directory
</pre></div>
</div>
</div>
</details><details class="sd-sphinx-override sd-dropdown sd-card sd-mb-3">
<summary class="sd-summary-title sd-card-header">
How to compile a shared library on Linux/IDAAS<div class="sd-summary-down docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-down" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M5.22 8.72a.75.75 0 000 1.06l6.25 6.25a.75.75 0 001.06 0l6.25-6.25a.75.75 0 00-1.06-1.06L12 14.44 6.28 8.72a.75.75 0 00-1.06 0z"></path></svg></div>
<div class="sd-summary-up docutils">
<svg version="1.1" width="1.5em" height="1.5em" class="sd-octicon sd-octicon-chevron-up" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M18.78 15.28a.75.75 0 000-1.06l-6.25-6.25a.75.75 0 00-1.06 0l-6.25 6.25a.75.75 0 101.06 1.06L12 9.56l5.72 5.72a.75.75 0 001.06 0z"></path></svg></div>
</summary><div class="sd-summary-content sd-card-body docutils">
<p class="sd-card-text"><strong>Linux/IDAAS  - .so</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>g++<span class="w"> </span>-c<span class="w"> </span>myModel.cpp<span class="w"> </span>-o<span class="w"> </span>myModel.o<span class="w"> </span>-std<span class="o">=</span>c++11<span class="w">  </span>Generate<span class="w"> </span>an<span class="w"> </span>object<span class="w"> </span>file
g++<span class="w"> </span>-shared<span class="w"> </span>myModel.o<span class="w"> </span>-o<span class="w"> </span>myModel.so<span class="w">  </span>outputs<span class="w"> </span>a<span class="w"> </span>.so<span class="w"> </span>named<span class="w"> </span>myModel.so
</pre></div>
</div>
</div>
</details></section>
</section>
<section id="additional-documentation">
<h2>Additional Documentation<a class="headerlink" href="#additional-documentation" title="Permalink to this heading"></a></h2>
<p>This documentation is very detailed in terms of code. It contains direct links to definitions of functions involved and is helpful for developers
who want to understand how RAT works in more detail.</p>
<p>The following documentation shows code along with visualizations.
Click on the link below to see the code.</p>
<p><a class="reference external" href="./api_reference/index.html">Additional Documentation</a></p>
<section id="dependency-graph">
<h3>Dependency Graph<a class="headerlink" href="#dependency-graph" title="Permalink to this heading"></a></h3>
<p>The following picture shows the dependency graph of RAT. The dependency graph is a graph that shows how the different components of RAT work together.
Click on the nodes to see the documentation of the component.</p>
<p>Click on the “Graph” to see the dependency graph.</p>
<p><a class="reference external" href="./api_reference/graph.html">Graph</a></p>
</section>
</section>
<section id="devops">
<h2>DevOps<a class="headerlink" href="#devops" title="Permalink to this heading"></a></h2>
<p>DevOps is extremely important for any software that needs faster deployments and easier maintenance of existing deployments and RAT is exactly that.</p>
<section id="jenkins">
<h3>Jenkins<a class="headerlink" href="#jenkins" title="Permalink to this heading"></a></h3>
<img alt="https://th.bing.com/th/id/OIP.GKIe0tehC6rMKoG86wMkewHaFb?w=266&amp;h=193&amp;c=7&amp;r=0&amp;o=5&amp;pid=1.7" src="https://th.bing.com/th/id/OIP.GKIe0tehC6rMKoG86wMkewHaFb?w=266&amp;h=193&amp;c=7&amp;r=0&amp;o=5&amp;pid=1.7" />
<p><a class="reference external" href="https://jenkins.io/">Jenkins</a> is a famous automation tool that automates building, testing and deploying. At the moment, it is used for building and testing but the deployments could be automated as well.
At STFC, there is a platform called Anvil (not be confused with Anvil the web development tool). Anvil is a service that hosts Jenkins instances for various teams across the STFC’s intranet.
This is managed by <strong>Alan Kyffin</strong>.</p>
</section>
<section id="stfc-cloud">
<h3>STFC Cloud<a class="headerlink" href="#stfc-cloud" title="Permalink to this heading"></a></h3>
<p>RAT owns two nodes/machines( Windows and Linux) in the cloud which are connected to Anvil. They help build,test the RAT in different operating systems.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>These nodes must be manually logged in if there’s any disruption in the STFC network (happens usually during updates/network-wide shutdowns).
In order to connect the nodes to Anvil, a command is used. This command can be obtained from Arwel Hughes.</p>
</div>
<section id="contacts">
<h4>Contacts<a class="headerlink" href="#contacts" title="Permalink to this heading"></a></h4>
<ol class="arabic simple">
<li><p>Issues with Linux node - Alexander Dibbo</p></li>
<li><p>Issues with Windows node - Simon Hodder (usually someone on his team will help)</p></li>
</ol>
</section>
</section>
<section id="work-flow">
<h3>Work Flow<a class="headerlink" href="#work-flow" title="Permalink to this heading"></a></h3>
<p>This section details how everything works together in the DevOps department.</p>
<ol class="arabic simple">
<li><p>First, there is GitHub repository at <a class="reference external" href="https://github.com/arwelHughes/RAT">RAT</a> which is source for all of the DevOps. Every time, there’s a Pull Request (PR) or a push, Jenkins gets triggered. This is achieved
using the Anvil Github App that recognizes these changes and initiates builds.</p></li>
<li><p>When Jenkins gets triggered, usually it builds according to the “Jenkinsfile” in the repository.”Jenkinsfile” is a file that contains the instructions for Jenkins to build the project. Jenkins sends these commands to the nodes in the cloud and build/tests the project.
If the build/test is successful, the PR or push is successful and the PR/push is merged. If the build/test is unsuccessful, the PR/push must be reviewed.</p></li>
</ol>
</section>
<section id="references-for-developers">
<h3>References for Developers<a class="headerlink" href="#references-for-developers" title="Permalink to this heading"></a></h3>
<ol class="arabic simple">
<li><p>Checkout the Architectural Decision Record (ADR) for RAT. This document contains all the decisions made in the past and why they were made.
This can be found in RasCal Planner in Microsoft Planner.</p></li>
<li></li>
</ol>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="targetFunctions.html" class="btn btn-neutral float-left" title="Target Functions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ADR.html" class="btn btn-neutral float-right" title="Architectural Decision Records" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Arwel Hughes,Sethu Pastula.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>